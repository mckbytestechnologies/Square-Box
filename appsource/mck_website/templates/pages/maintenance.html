<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Request Form</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f9fafb;
        }
        .form-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        .form-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        .form-subtitle {
            color: #6c757d;
            font-size: 15px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 6px;
        }
        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #eef6ff;
        }
        .file-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        .preview-item {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            background: #fff;
        }
        .file-name {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }
        .file-size {
            font-size: 12px;
            color: #6c757d;
        }
        .btn-primary {
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
        }
        .alert-danger {
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    {% include "includes/header.html" %}

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="form-card">
                    <div class="form-header text-center mb-4">
                        <h2><i class="fas fa-tools me-2 text-primary"></i>Maintenance Request</h2>
                        <p class="form-subtitle">Report any maintenance issues with your property</p>
                    </div>

                    <form id="maintenance_form" method="POST" action="{% url 'vlr_website:mck_ajax_maintenance_save' %}" enctype="multipart/form-data" class="needs-validation" novalidate>
                        <!-- Error Message -->
                        <div class="alert alert-danger" id="form_error" style="display:none;"></div>

                        <!-- Request Details -->
                        <div class="mb-4">
                            <h5 class="section-title"><i class="fas fa-info-circle me-2 text-primary"></i>Request Details</h5>
                            <div class="mb-3">
                                <label class="form-label">Description <span class="text-danger">*</span></label>
                                <textarea name="description" class="form-control" rows="4" required placeholder="Describe the issue in detail"></textarea>
                                <div class="invalid-feedback">Please provide a description</div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Urgency <span class="text-danger">*</span></label>
                                    <select name="urgency" class="form-select" required>
                                        <option value="">Select urgency</option>
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                    <div class="invalid-feedback">Please select urgency</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Preferred Date</label>
                                    <input type="date" name="preferred_date" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Attachments -->
                        <div class="mb-4">
                            <h5 class="section-title"><i class="fas fa-paperclip me-2 text-primary"></i>Attachments</h5>
                            <div class="file-upload-wrapper">
                                <input type="file" name="attachment" id="maintenance_attachments" class="d-none" multiple>
                                <div class="upload-area" id="upload_area">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                    <p class="mb-1">Drag & drop files or click to browse</p>
                                    <small class="text-muted">Max 5 files, 10MB each</small>
                                </div>
                                <div id="file-preview" class="file-preview-grid"></div>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="submit_btn">
                                <i class="fas fa-save me-2"></i> Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% include "includes/footer_main.html" %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    $(document).ready(function() {
        const fileInput = $('#maintenance_attachments');
        const uploadArea = $('#upload_area');
        const filePreview = $('#file-preview');

        fileInput.on('change', function() {
            filePreview.empty();
            const files = this.files;
            if (files.length > 5) {
                showError("You can upload a maximum of 5 files");
                fileInput.val('');
                return;
            }
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > 10 * 1024 * 1024) {
                    showError(file.name + " is too large (max 10MB)");
                    fileInput.val('');
                    filePreview.empty();
                    return;
                }
                const previewItem = $('<div class="preview-item"></div>');
                previewItem.append('<div class="file-name">'+file.name+'</div>');
                previewItem.append('<div class="file-size">'+formatFileSize(file.size)+'</div>');
                filePreview.append(previewItem);
            }
        });

        uploadArea.on('click', function() { fileInput.click(); });
        uploadArea.on('dragover', function(e) { e.preventDefault(); $(this).addClass('dragover'); });
        uploadArea.on('dragleave', function(e) { e.preventDefault(); $(this).removeClass('dragover'); });
        uploadArea.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
            fileInput[0].files = e.originalEvent.dataTransfer.files;
            fileInput.trigger('change');
        });

        $('#maintenance_form').on('submit', function(e) {
            e.preventDefault();
            const form = $(this);
            const submitBtn = $('#submit_btn');
            submitBtn.prop('disabled', true);
            if (!form[0].checkValidity()) {
                form.addClass('was-validated');
                submitBtn.prop('disabled', false);
                return;
            }
            const formData = new FormData(form[0]);
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function(res) {
                    if (res.status === "success") {
                        alert("Request submitted successfully!");
                        window.location.reload();
                    } else {
                        showError(res.message || "Failed to submit request");
                    }
                },
                error: function() { showError("An error occurred while submitting request"); },
                complete: function() { submitBtn.prop('disabled', false); }
            });
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes','KB','MB','GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        function showError(msg) {
            $('#form_error').text(msg).show();
            $('html, body').animate({ scrollTop: $('#form_error').offset().top - 100 }, 500);
        }
    });
    </script>
</body>
</html>
